% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/binary-analysis_stability.R
\name{plot_similarity_heatmap}
\alias{plot_similarity_heatmap}
\title{Plot similarity heatmap for exactly two (group × time) combinations}
\usage{
plot_similarity_heatmap(
  sim_tbl,
  groups = NULL,
  times = NULL,
  pairing = c("cross", "same"),
  cluster = c("none", "rows", "cols", "both"),
  dyads = c("only", "order", "no"),
  grid = c("union_pad", "require_full", "intersection", "observed_only"),
  dedupe = c("mean", "first", "median", "max", "min"),
  limits = c(0, 1),
  na_fill = "#F0F0F0",
  verbose = .ph_opt("verbose", TRUE)
)
}
\arguments{
\item{sim_tbl}{Lazy DuckDB table from \code{compute_repertoire_similarity()}.
New schema columns: \code{time_left}, \code{group_left}, \code{subject_left},
\code{time_right}, \code{group_right}, \code{subject_right}, \code{similarity}, \code{pairing}.
Legacy schema columns (auto-adapted): \code{timepoint}, \code{group_left},
\code{subject_left}, \code{group_right}, \code{subject_right}, \code{similarity}.}

\item{groups}{Character(2) or NULL. If NULL, there must be \strong{one} group in
the table and you must supply \code{times = c(t1, t2)}.}

\item{times}{Character(2) or NULL. If \code{groups} is given, \code{times[1]} pairs
with \code{groups[1]}, \code{times[2]} with \code{groups[2]}. If \code{groups} is NULL, both
times are used within the single group in the table.}

\item{pairing}{One of \verb{"cross","same"}. \code{"same"} = same timepoint on both
sides; \code{"cross"} = different timepoints.}

\item{cluster}{One of \verb{"none","rows","cols","both"}. Hierarchical clustering
to reorder axes (performed locally after collecting).}

\item{limits}{Length-2 numeric for fill scale limits. Default \code{c(0,1)}.}

\item{na_fill}{Colour for NA cells. Default \code{"#F0F0F0"}.}

\item{verbose}{Logical; pass-through to PHIP logger.}
}
\value{
A \code{ggplot2} object (modifiable).
}
\description{
Build a subject-by-subject similarity \strong{heatmap} from the DuckDB table
created by \code{compute_repertoire_similarity()} with \code{time_mode = "pairwise"}
and \code{subject_mode = "all"}.

\strong{Hard constraints:}
\itemize{
\item Only \strong{two} distinct (group × time) combos are allowed.
\item A \strong{full} matrix is required (every left-subject × right-subject present).
\item If no group was used, you must provide \strong{two times}.
}

The function validates inputs and aborts early with PHIP-style messages.
If dyad columns are present (\code{dyad_left}, \code{dyad_right}), you can:
\itemize{
\item restrict to dyad-intersection to make the matrix square (\code{dyads = "only"}),
\item just order axes by dyad but keep all pairs (\code{dyads = "order"}),
\item ignore dyads (\code{dyads = "no"}).
}
}
