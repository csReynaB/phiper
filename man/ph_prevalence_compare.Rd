% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prevalence-testing.R
\name{ph_prevalence_compare}
\alias{ph_prevalence_compare}
\title{Prevalence by group with pairwise tests (multi-rank; phiper logging)}
\usage{
ph_prevalence_compare(
  x,
  rank_cols,
  group_cols,
  exist_col = "exist",
  prevalence_threshold = 0,
  p_adjust = "BH",
  parallel = NULL,
  compute_ratios_db = TRUE,
  interaction = FALSE,
  combine_cols = NULL,
  interaction_sep = "::",
  collect = TRUE,
  register_name = NULL
)
}
\arguments{
\item{x}{phip_data or long data.frame with sample_id, peptide_id, \code{exist_col}, \code{group_cols}}

\item{rank_cols}{character vector of ranks (e.g., c("peptide_id","species"))}

\item{group_cols}{character vector of grouping columns}

\item{exist_col}{presence indicator (default "exist")}

\item{prevalence_threshold}{percent threshold for pairwise keep (default 0)}

\item{p_adjust}{kept for future extensibility (current: BH in DuckDB)}

\item{parallel}{logical or NULL. NULL = auto (uses future plan if available)}

\item{compute_ratios_db}{logical; compute ratio/delta_ratio in DB (default TRUE)}

\item{interaction}{logical; if TRUE combine two grouping cols and test only that}

\item{combine_cols}{length-2 character vector from \code{group_cols} when interaction=TRUE}

\item{interaction_sep}{separator between combined levels (default "::")}

\item{collect}{logical; if TRUE return a collected tibble; else a DuckDB TABLE (lazy tbl)}

\item{register_name}{optional TABLE name when collect=FALSE; if NULL timestamped.}
}
\value{
collected tibble or materialized DuckDB TABLE (lazy \code{tbl}).
}
\description{
Compute per-group counts/percentages for one or more ranks and build all
pairwise comparisons within each grouping variable (or a combined interaction).
All joins/counts/ratios are executed in DuckDB. P-values are computed in R
(chunked; auto-parallel if a \code{future} plan is active). BH/FDR is computed
inside DuckDB per \code{group_col}.

Testing is \strong{adaptive}:
\itemize{
\item If all four expected counts in the 2x2 are ≥ 5, use chi-square with Yates
continuity correction (\code{stats::prop.test(..., correct = TRUE)}).
\item Otherwise use Fisher’s exact test.
}
}
