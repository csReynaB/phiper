% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prevalence-DELTA_test2.R
\name{ph_prevalence_shift2}
\alias{ph_prevalence_shift2}
\title{Global shift in peptide-level prevalence via subject-level permutation}
\usage{
ph_prevalence_shift2(
  x,
  rank_cols,
  group_cols,
  exist_col = "exist",
  interaction = FALSE,
  combine_cols = NULL,
  interaction_sep = "::",
  B_permutations = 2000L,
  seed = 1L,
  smooth_eps_num = 0.5,
  smooth_eps_den_mult = 2,
  min_max_prev = 0,
  weight_mode = c("equal", "se_invvar", "n_eff_sqrt"),
  stat_mode = c("diff", "asin"),
  prev_strat = c("none", "decile"),
  winsor_z = 4,
  parallel = NULL,
  rank_feature_keep = NULL,
  peptide_library = NULL,
  auto_fetch_library = FALSE,
  log = FALSE,
  log_file = "ph_prevalence_shift.log",
  stream_path = NULL,
  return_results = TRUE,
  append_stream = FALSE,
  fold_change = c("none", "sum", "mean", "max", "median"),
  cross_prev = c("none", "sum", "mean", "max", "median")
)
}
\arguments{
\item{x}{A \code{phip_data} (recommended; must carry \code{peptide_library} when
\code{rank_cols} include non-\code{peptide_id}) or a data.frame with the necessary
columns.}

\item{rank_cols}{Character vector of rank columns (e.g. \code{"peptide_id"},
\code{"species"}, ...). Non-peptide ranks are joined from \code{x$peptide_library}.}

\item{group_cols}{Character vector of grouping columns that define universes;
pairwise contrasts are constructed within each universe.}

\item{exist_col}{Name of the 0/1 presence column. Default \code{"exist"}.}

\item{interaction}{Logical; if \code{TRUE}, also create the interaction of the
first two \code{group_cols}. Ignored if \code{combine_cols} is set.}

\item{combine_cols}{Optional length-2 vector; if provided, only that
interaction is used as \code{group_col}.}

\item{interaction_sep}{Separator for interaction values. Default \code{"::"}.}

\item{B_permutations}{Number of permutations \code{B}. Default \code{2000L}.}

\item{seed}{RNG seed. Default \code{1L}.}

\item{smooth_eps_num}{Laplace numerator epsilon. Default \code{0.5}.}

\item{smooth_eps_den_mult}{Multiplier for denominator epsilon. Default \code{2.0}.}

\item{min_max_prev}{Keep peptides with \verb{max(p1, p2) >=} this. Default \code{0.0}.}

\item{weight_mode}{One of \code{c("equal","se_invvar","n_eff_sqrt")}.}

\item{stat_mode}{One of \code{c("diff","asin")}.}

\item{prev_strat}{One of \code{c("none","decile")} for prevalence-stratified
combining.}

\item{winsor_z}{Winsorization threshold for per-peptide z. Default \code{4.0}.}

\item{parallel}{Reserved (not used internally). Default \code{NULL}.}

\item{rank_feature_keep}{Optional \strong{named list} \verb{rank -> values to keep};
filters \verb{(rank, feature)} after pivot.}

\item{collect}{Keep \code{TRUE}; materialization is not required here.}

\item{register_name}{Reserved; no-op here.}

\item{progress_perm_every}{Print a small log every k permutations. Default \code{1L}.}
}
\value{
A tibble with one row per tested stratum:
\verb{rank, feature, group_col, group1, group2, design, n_subjects_paired, n_peptides_used, T_obs, p_perm, p_adj_rank, mean_delta, frac_delta_pos, mean_delta_w, frac_delta_pos_w, category_rank_bh}.
}
\description{
Tests for a \strong{global} (genome/antigen-wide) shift in peptide-level prevalence
between two groups within each \verb{(rank, feature, group_col)} stratum by
aggregating per-peptide effects into a single Stouffer-type statistic and
assessing significance via \strong{label permutation} (paired or unpaired, chosen
automatically from the data).
}
\details{
\strong{Overview.} For each stratum \verb{(rank, feature, group_col)} that yields a
unique ordered pair of groups \verb{(g1, g2)}, the method:
\enumerate{
\item \strong{Peptide-level prevalence with smoothing.}
For each peptide, compute smoothed prevalences in \code{g1} and \code{g2}:
\deqn{ \hat p_k = \frac{x_k + \varepsilon}{n_k + \lambda \varepsilon}, \; k \in \{g1,g2\} , }
where \code{x_k} is the number of samples with presence (\code{exist > 0}), \code{n_k}
is the number of (distinct) samples (or paired subjects), \verb{\\varepsilon}
is \code{smooth_eps_num}, and \verb{\\lambda} is \code{smooth_eps_den_mult}. Peptides with
\verb{max( \\hat p_\{g1\}, \\hat p_\{g2\} ) < min_max_prev} are discarded.
\item \strong{Per-peptide effect and z-score (\code{stat_mode}).}
\itemize{
\item \code{"diff"}: effect \eqn{\Delta = \hat p_{g2} - \hat p_{g1}} with
\eqn{ SE = \sqrt{\hat p_{g1}(1-\hat p_{g1})/n_{g1} + \hat p_{g2}(1-\hat p_{g2})/n_{g2}} } and
\eqn{ z = \Delta / SE } (guarded by a tiny floor).
\item \code{"asin"}: variance-stabilized difference of angles:
\eqn{ z = \frac{\arcsin\sqrt{\hat p_{g2}} - \arcsin\sqrt{\hat p_{g1}}}{ \sqrt{ 1/(4n_{g1}) + 1/(4n_{g2}) } } .}
Each \eqn{z} is \strong{winsorized} to \eqn{\pm} \code{winsor_z}.
}
\item \strong{Weights (\code{weight_mode}).}
\itemize{
\item \code{"equal"}: all peptides weight 1.
\item \code{"se_invvar"}: inverse standard error (or the analogous denominator for
\code{"asin"}).
\item \code{"n_eff_sqrt"}: \eqn{ \sqrt{ n_{g1}\hat p_{g1} + n_{g2}\hat p_{g2} } } (proxy for expected positives).
}
\item \strong{Combine into one test statistic (Stouffer).}
Let \eqn{w_i} be weights and \eqn{z_i} peptide z-scores.
\itemize{
\item If \code{prev_strat = "none"}:
\deqn{ T_{\mathrm{obs}} = \frac{ \sum_i w_i z_i }{ \sqrt{ \sum_i w_i^2 } } . }
\item If \code{prev_strat = "decile"}: bin peptides by deciles of pooled prevalence
\eqn{ (\;n_{g1}\hat p_{g1} + n_{g2}\hat p_{g2}\;)/(\;n_{g1}+n_{g2}\;) } and combine a
Stouffer \eqn{T_b} within each bin; report the \strong{mean} of bin-level z’s
as \eqn{T_{\mathrm{obs}}} (stabilizes across prevalence regimes).
}
\item \strong{Permutation scheme and p-value.}
We compute a \strong{two-sided} permutation p-value for the global shift:
\itemize{
\item \strong{Paired design:} when both groups have measurements for the same
\code{subject_id}, we independently flip each subject’s labels (\code{g1}↔\code{g2})
with 50/50 probability, recompute all steps (1–4) to get \eqn{T_b}.
\item \strong{Unpaired design:} we shuffle sample labels while \strong{preserving group
sizes} (draw a random split of samples into \code{n1}/\code{n2}), recompute (1–4)
to get \eqn{T_b}.
}

With \eqn{B} permutations, the p-value is
\deqn{ p = \frac{1 + \sum_{b=1}^{B} \mathbf{1}\{ |T_b| \ge |T_{\mathrm{obs}}| \} }{1 + B} , }
which is the standard \emph{add-one} estimate ensuring non-zero p under the
global null.
\item \strong{Multiplicity.} For each \code{rank}, apply BH to \code{p_perm} → \code{p_adj_rank}.
}

\strong{Notes.}
\itemize{
\item If a stratum doesn’t contain exactly two group levels, it’s skipped.
\item Progress can be printed every \code{progress_perm_every} permutations.
}
}
