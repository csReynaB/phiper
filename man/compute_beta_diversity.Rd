% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/binary-analysis_beta.R
\name{compute_beta_diversity}
\alias{compute_beta_diversity}
\alias{compute_beta_diversity.phip_data}
\alias{compute_beta_diversity.data.frame}
\title{Compute beta diversity (PCoA / CAP, PERMANOVA, dispersion)}
\usage{
compute_beta_diversity(x, ...)

\method{compute_beta_diversity}{phip_data}(
  x,
  group_cols = NULL,
  ranks = "peptide_id",
  fc_threshold = NULL,
  method_normalization = c("auto", "relative", "hellinger", "log", "none"),
  distance = "bray",
  permutations = 999,
  time_col = NULL,
  carry_cols = NULL,
  filter_rank = NULL,
  baseline_level = NULL,
  contrasts = "none",
  mtp = NULL,
  group_interaction = FALSE,
  interaction_sep = " * ",
  n_threads = max(1L, (if (rlang::is_installed("parallel")) parallel::detectCores() else
    1L) - 1L),
  method_pcoa = c("joint", "separate_group", "separate_time", "separate_all", "cap"),
  neg_correction = c("none", "lingoes", "cailliez"),
  time_force_continuous = FALSE,
  ...
)

\method{compute_beta_diversity}{data.frame}(
  x,
  group_cols = NULL,
  ranks = "peptide_id",
  fc_threshold = NULL,
  method_normalization = c("auto", "relative", "hellinger", "log", "none"),
  distance = "bray",
  permutations = 999,
  time_col = NULL,
  carry_cols = NULL,
  filter_rank = NULL,
  baseline_level = NULL,
  contrasts = "none",
  mtp = NULL,
  group_interaction = FALSE,
  interaction_sep = " * ",
  n_threads = max(1L, (if (rlang::is_installed("parallel")) parallel::detectCores() else
    1L) - 1L),
  method_pcoa = c("joint", "separate_group", "separate_time", "separate_all", "cap"),
  neg_correction = c("none", "lingoes", "cailliez"),
  time_force_continuous = FALSE,
  ...
)
}
\arguments{
\item{x}{A \verb{<phip_data>} object or a long \code{data.frame}.}

\item{group_cols}{Character vector of grouping columns, or \code{NULL} for a
single \strong{non-facetted} view called \code{"all_samples"}. Columns must exist.}

\item{ranks}{Character vector of \strong{exact column names} to aggregate by.}

\item{fc_threshold}{Numeric or \code{NULL}. Presence rule (see Details).}

\item{method_normalization}{One of \code{"auto"}, \code{"relative"}, \code{"hellinger"},
\code{"log"}, \code{"none"}.}

\item{distance}{Distance method (e.g., \code{"bray"}, \code{"jaccard"}, \code{"euclidean"},
\code{"manhattan"}, \code{"canberra"}, \code{"cosine"}). (Backward-compat: \code{method}.)}

\item{permutations}{Number of permutations for adonis2 / permutest
(default \code{999}). Use \code{0} to skip permutation tests.}

\item{time_col}{Optional \strong{categorical} time column (e.g., \code{"timepoint"}).}

\item{carry_cols}{Optional character vector of extra columns to carry into
outputs (joined by \code{sample_id}).}

\item{filter_rank}{Optional vector or function to limit levels of each \code{rank}.}

\item{baseline_level}{Optional baseline level name for \code{"baseline"} contrasts.
For time, if \code{NULL}, the earliest level is used.}

\item{contrasts}{One or more of \code{"none"}, \code{"pairwise"}, \code{"each_vs_rest"}
(alias \code{"group_vs_rest"}), \code{"baseline"}. Default \code{"none"}.}

\item{mtp}{Multiple-testing correction method passed to \code{p.adjust}
(default \code{.ph_opt("beta.mtp","BH")}).}

\item{n_threads}{Integer; threads for parallelDist (default: all cores - 1).}

\item{method_pcoa}{One of \code{"joint"}, \code{"separate_group"}, \code{"separate_time"},
\code{"separate_all"}, \code{"cap"}. Controls ordination splitting / CAP.}

\item{neg_correction}{One of \code{"none"}, \code{"lingoes"}, \code{"cailliez"}.}
}
\value{
A \strong{named list} (one element per view or subview) with class
\code{"phip_beta_diversity"}. Each element contains:
\itemize{
\item \code{pcoa}: tibble with first k axes (see option \code{phiper.beta.eig_axes}).
\item \code{pcoa_full}: \strong{all} axes (diagnostics).
\item \code{var_explained}: \verb{\%PCoA1…\%PCoAk} plus \verb{\%Other} (normalized by sum of
\strong{positive} eigenvalues from the \strong{full} spectrum).
\item \code{eigen_summary}: first k rows + \strong{Other}; includes \code{n_pos}, \code{n_neg}.
\item \code{eig_full}: all raw eigenvalues.
\item \code{feature_loadings}: weighted-average loadings (wide, axis-block order).
\item \code{tests}: global PERMANOVA + requested contrasts (tidy).
\item \code{dispersion}: per-sample centroid distances (+ contrast tests).
}
}
\description{
Computes between-sample diversity for one or more \strong{ranks}
via a dissimilarity matrix, \strong{PCoA} scores, optional \strong{CAP/dbRDA},
\strong{PERMANOVA} (adonis2; always global maximal model) and \strong{dispersion}
(betadisper + permutest). Optional post-hoc contrasts can be requested.
}
\details{
\subsection{Ranks}{

\emph{The peptide identities or characteristics you aggregate by}. Must be \strong{exact
column names}:
\itemize{
\item For \verb{<phip_data>}: columns from the Vogl Lab peptide library (e.g.,
\code{peptide_id}, lineage/taxa fields).
\item For \code{data.frame}: columns present in your long table.
}
}

\subsection{Presence rule}{
\itemize{
\item Default (\code{fc_threshold = NULL}): presence is \code{exist > 0}.
\item If \code{fc_threshold} is numeric, presence is \code{fold_change > fc_threshold}.
}
}

\subsection{Full-cross / auto-expanded zeros}{

For \verb{<phip_data>} created with a full cross (synthetic zero rows), those are
pruned \strong{upfront} (keep only present rows) to reduce compute, matching the
alpha-diversity behavior.
}

\subsection{Normalization}{

\code{method_normalization} controls how the wide abundance matrix is transformed
\emph{before} distances:
\itemize{
\item \code{"auto"}: if presence-by-\code{exist}, keep counts (binary) as-is; else use
\code{"relative"}.
\item \code{"relative"}: divide each row by its row sum.
\item \code{"hellinger"}: sqrt of relative.
\item \code{"log"}: \code{log1p}.
\item \code{"none"}: leave counts as-is.
}
}

\subsection{Distance engine}{

Uses \strong{parallelDist} when supported by the requested \code{distance} method.
For methods not implemented in parallelDist (e.g., \code{"bray"}), it uses a
\strong{threaded Bray} via the identity \code{BC(x,y) = L1(x,y) / (sum(x)+sum(y))}.
Otherwise falls back to \code{vegan::vegdist}.
}

\subsection{Ordination mode}{

\code{method_pcoa} controls \emph{how} ordinations are computed:
\code{"joint"}, \code{"separate_group"}, \code{"separate_time"}, \code{"separate_all"}, \code{"cap"}.
\itemize{
\item \code{"cap"} uses \code{vegan::capscale} with constrained axes determined by
available predictors; others use (w)cmdscale on the distance.
}
}

\subsection{Negative eigenvalues}{

\code{neg_correction}: \code{"none"}, \code{"lingoes"}, or \code{"cailliez"}. Applied via
\code{vegan::wcmdscale(add=)} (PCoA) or \code{capscale(add=)} (CAP).
}

\subsection{Testing (ALWAYS global, with optional contrasts)}{
\itemize{
\item PERMANOVA always runs a \strong{global maximal model}:
\code{dist ~ group + time + group:time} (dropping terms not available).
If \code{time_col} is present and \code{subject_id} exists, permutations are
\strong{stratified by subject_id}.
\item Dispersion (betadisper + permutest) is run \strong{globally} for each available
factor (\code{group}, \code{time}, \code{group:time}) and can also run \strong{contrasts}.
\item \code{contrasts}: \code{"none"}, \code{"pairwise"}, \code{"each_vs_rest"} (alias \code{"group_vs_rest"}),
or \code{"baseline"} (provide \code{baseline_level}).
\item Multiple-testing correction is applied \strong{within each (view × rank)} using
\code{mtp} (default \code{.ph_opt("beta.mtp","BH")}). Use \code{"none"} to skip.
}
}
}
